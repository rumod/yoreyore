<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>요래됐슴당</title>
  
  <!-- 라이브러리 로드 -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
    :root { --mint: #76D7C4; }
    body {
      background-color: #f8fafc;
      font-family: 'Pretendard', sans-serif;
      margin: 0; padding: 0;
      display: flex; justify-content: center;
      color: #1e293b;
      -webkit-tap-highlight-color: transparent;
    }
    #root {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      background: white;
      position: relative;
      display: flex;
      flex-direction: column;
      box-shadow: 0 4px 25px rgba(0,0,0,0.05);
    }
    .mint-bg { background-color: var(--mint); }
    .mint-text { color: var(--mint); }
    .animate-float { animation: float 3s ease-in-out infinite; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    video { width: 100%; height: 100%; object-fit: cover; }
    .ghost {
      position: absolute; inset: 0; opacity: 0.35;
      mix-blend-mode: screen; pointer-events: none; object-fit: cover;
    }
    .safe-top { padding-top: env(safe-area-inset-top, 16px); }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 16px); }
    
    /* 버튼 스타일 */
    .btn-primary {
      width: 100%;
      padding: 1rem;
      border-radius: 1rem;
      font-weight: 700;
      font-size: 1.125rem;
      transition: all 0.2s;
      background-color: var(--mint);
      color: white;
      box-shadow: 0 4px 12px rgba(118, 215, 196, 0.3);
    }
    .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
    .btn-secondary {
      width: 100%;
      padding: 0.875rem;
      border-radius: 1rem;
      font-weight: 600;
      font-size: 1rem;
      background-color: #f1f5f9;
      color: #475569;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const MINT = '#76D7C4';
    const KEY = 'YORAE_DATA_FINAL';

    // 이미지 로드 헬퍼
    const loadImage = (src) => new Promise((res) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => res(img);
      img.src = src;
    });

    // 결과 이미지 생성 (병합)
    const createResult = async (beforeSrc, afterSrc, time) => {
      const [imgB, imgA] = await Promise.all([loadImage(beforeSrc), loadImage(afterSrc)]);
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const aw = imgA.width, ah = imgA.height;
      const isPortrait = ah > aw;

      if (isPortrait) {
        canvas.width = aw * 2; canvas.height = ah;
      } else {
        canvas.width = aw; canvas.height = ah * 2;
      }

      const drawCrop = (img, x, y, tw, th) => {
        const iRatio = img.width / img.height;
        const tRatio = tw / th;
        let sx, sy, sw, sh;
        if (iRatio > tRatio) {
          sh = img.height; sw = img.height * tRatio;
          sx = (img.width - sw) / 2; sy = 0;
        } else {
          sw = img.width; sh = img.width / tRatio;
          sx = 0; sy = (img.height - sh) / 2;
        }
        ctx.drawImage(img, sx, sy, sw, sh, x, y, tw, th);
      };

      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      if (isPortrait) {
        drawCrop(imgB, 0, 0, aw, ah);
        ctx.drawImage(imgA, aw, 0, aw, ah);
      } else {
        drawCrop(imgB, 0, 0, aw, ah);
        ctx.drawImage(imgA, 0, ah, aw, ah);
      }

      // 하단 텍스트 바
      const fontSize = Math.round(canvas.height * 0.03);
      ctx.font = `bold ${fontSize}px sans-serif`;
      const txt = `${new Date().toLocaleDateString()} | ${time}분 소요 | 요래됐슴당 ✨`;
      const tw = ctx.measureText(txt).width;
      const bw = tw + fontSize * 2, bh = fontSize * 1.8;
      const bx = (canvas.width - bw) / 2, by = canvas.height - bh - fontSize;

      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      if (ctx.roundRect) ctx.roundRect(bx, by, bw, bh, bh/2); else ctx.rect(bx, by, bw, bh);
      ctx.fill();

      ctx.fillStyle = 'white';
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(txt, bx + bw / 2, by + bh / 2 + 1);

      return canvas.toDataURL('image/jpeg', 0.9);
    };

    const App = () => {
      const [step, setStep] = useState('HOME');
      const [mode, setMode] = useState('BEFORE');
      const [data, setData] = useState({ b: null, start: null, res: null });
      const [ghost, setGhost] = useState(true);
      const [loading, setLoading] = useState(false);
      
      const vRef = useRef(null);
      const fRef = useRef(null);

      // 로컬 스토리지에서 복구
      useEffect(() => {
        const saved = localStorage.getItem(KEY);
        if (saved) {
          const p = JSON.parse(saved);
          setData(d => ({ ...d, b: p.b, start: p.start }));
          if (p.b) setStep('CLEAN');
        }
      }, []);

      // 카메라 시작
      const startCam = async () => {
        try {
          const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          if (vRef.current) vRef.current.srcObject = s;
        } catch (e) { 
          alert("카메라 권한이 필요합니다."); 
          setStep('HOME'); 
        }
      };

      useEffect(() => {
        if (step === 'CAM') startCam();
        return () => {
          if (vRef.current?.srcObject) {
            vRef.current.srcObject.getTracks().forEach(t => t.stop());
          }
        };
      }, [step]);

      const onCaptured = (blob) => {
        const r = new FileReader();
        r.readAsDataURL(blob);
        r.onloadend = async () => {
          const b64 = r.result;
          if (mode === 'BEFORE') {
            const now = Date.now();
            setData(prev => ({ ...prev, b: b64, start: now }));
            localStorage.setItem(KEY, JSON.stringify({ b: b64, start: now }));
            setStep('CLEAN');
          } else {
            setLoading(true);
            const dur = data.start ? Math.max(1, Math.round((Date.now() - data.start) / 60000)) : 1;
            const res = await createResult(data.b, b64, dur);
            setData(prev => ({ ...prev, res }));
            setStep('RESULT');
            setLoading(false);
          }
        };
      };

      const takePhoto = () => {
        const v = vRef.current;
        if (!v) return;
        const c = document.createElement('canvas');
        c.width = v.videoWidth; c.height = v.videoHeight;
        c.getContext('2d').drawImage(v, 0, 0);
        c.toBlob(b => b && onCaptured(b), 'image/jpeg', 0.9);
      };

      return (
        <div className="flex flex-col flex-1">
          {loading && (
            <div className="fixed inset-0 bg-white/80 z-[100] flex flex-col items-center justify-center">
              <div className="w-8 h-8 border-4 border-slate-200 border-t-[#76D7C4] rounded-full animate-spin mb-3"></div>
              <p className="font-bold text-slate-600 text-sm">결과물을 만드는 중...</p>
            </div>
          )}

          {step === 'HOME' && (
            <div className="flex-1 flex flex-col items-center justify-center px-8 text-center">
              <div className="text-6xl mb-6 animate-float">✨</div>
              <h1 className="text-3xl font-extrabold mb-2 tracking-tight">요래됐슴당</h1>
              <p className="text-slate-500 font-medium mb-12 text-sm leading-relaxed px-4">
                이랬는데~ 요래됐슴당!<br/>청소 전후의 극적인 변화를 기록하세요.
              </p>
              <button onClick={() => { setStep('CAM'); setMode('BEFORE'); }} className="btn-primary">기록 시작하기</button>
            </div>
          )}

          {step === 'CAM' && (
            <div className="fixed inset-0 bg-black z-50 flex flex-col max-w-[480px] mx-auto">
              <div className="absolute top-0 inset-x-0 p-5 flex justify-between items-center z-50 safe-top">
                <button onClick={() => setStep(mode==='BEFORE'?'HOME':'CLEAN')} className="p-2 bg-white/10 rounded-full text-white backdrop-blur-md">
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M15 19l-7-7 7-7"/></svg>
                </button>
                <div className="px-3 py-1 bg-white/20 rounded-full text-white font-bold text-[10px] tracking-wider uppercase">{mode} SHOOT</div>
                <div className="w-9"></div>
              </div>
              <div className="flex-1 relative bg-zinc-900 flex items-center justify-center overflow-hidden">
                <video ref={vRef} autoPlay playsInline muted />
                {mode === 'AFTER' && ghost && data.b && <img src={data.b} className="ghost" />}
              </div>
              <div className="h-36 bg-zinc-950 flex justify-between items-center px-8 safe-bottom">
                <div className="w-12">
                  {mode === 'AFTER' && (
                    <button onClick={()=>setGhost(!ghost)} className={`w-12 h-12 rounded-xl border flex flex-col items-center justify-center text-[10px] font-bold ${ghost?'border-white text-white':'border-white/20 text-white/30'}`}>
                      GHOST
                    </button>
                  )}
                </div>
                <button onClick={takePhoto} className="w-16 h-16 bg-white rounded-full border-[4px] border-zinc-800 shadow-xl active:scale-95 transition-transform"></button>
                <button onClick={()=>fRef.current.click()} className="w-12 h-12 bg-zinc-800 rounded-xl flex items-center justify-center text-white">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                </button>
                <input type="file" ref={fRef} className="hidden" accept="image/*" onChange={(e)=>e.target.files[0] && onCaptured(e.target.files[0])} />
              </div>
            </div>
          )}

          {step === 'CLEAN' && (
            <div className="flex-1 flex flex-col items-center justify-center px-8 text-center">
              <div className="relative mb-10">
                <div className="w-52 h-52 rounded-[2.5rem] overflow-hidden shadow-xl border-4 border-slate-50">
                  <img src={data.b} className="w-full h-full object-cover grayscale-[0.3]" />
                </div>
                <div className="absolute -bottom-3 left-1/2 -translate-x-1/2">
                  <span className="bg-slate-800 text-white px-4 py-1.5 rounded-full font-bold text-sm shadow-lg">BEFORE</span>
                </div>
              </div>
              <h2 className="text-2xl font-extrabold mb-4 text-slate-800">청소를 완료하셨나요?</h2>
              <p className="text-slate-500 text-sm mb-10">변화된 공간의 사진을 찍어<br/>비교샷을 완성하세요!</p>
              <button onClick={()=>{setStep('CAM'); setMode('AFTER');}} className="btn-primary">요래됐슴당 촬영</button>
              <button onClick={()=>{if(confirm("기록을 삭제할까요?")){localStorage.removeItem(KEY); setData({b:null,start:null,res:null}); setStep('HOME');}}} className="mt-8 text-slate-400 font-bold text-xs underline uppercase tracking-widest">Reset</button>
            </div>
          )}

          {step === 'RESULT' && (
            <div className="flex-1 flex flex-col px-6 py-8 overflow-y-auto">
              <div className="text-center mt-6 mb-8">
                <span className="text-[10px] font-bold tracking-[0.2em] text-[#76D7C4] uppercase">Magic Complete</span>
                <h1 className="text-3xl font-black mt-1">요래됐슴당!</h1>
              </div>
              <div className="rounded-2xl overflow-hidden shadow-xl border-2 border-slate-50 mb-8 bg-slate-50">
                <img src={data.res} className="w-full h-auto" />
              </div>
              <div className="space-y-3 pb-8 safe-bottom">
                <button onClick={()=>{const a=document.createElement('a'); a.href=data.res; a.download=`yorae_${Date.now()}.jpg`; a.click();}} className="btn-primary">이미지 저장하기</button>
                <button onClick={()=>{localStorage.removeItem(KEY); setData({b:null,start:null,res:null}); setStep('HOME');}} className="btn-secondary">새로 기록하기</button>
              </div>
            </div>
          )}
        </div>
      );
    };

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>
</html>